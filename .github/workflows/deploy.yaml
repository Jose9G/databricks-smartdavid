name: Deploy Notebooks to Databricks

on:
  push:
    branches:
      - main        # Deploy a producciÃ³n al hacer push a main
  pull_request:
    branches:
      - dev         # ValidaciÃ³n al hacer PR hacia dev

jobs:
  deploy:
    name: Deploy ETL Notebooks - SmartDavid
    runs-on: ubuntu-latest

    steps:
      # â”€â”€ Paso 1: Clonar el repositorio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v3

      # â”€â”€ Paso 2: Instalar Python â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # â”€â”€ Paso 3: Instalar Databricks CLI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install Databricks CLI
        run: |
          pip install databricks-cli
          databricks --version

      # â”€â”€ Paso 4: Configurar autenticaciÃ³n con Databricks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Configure Databricks CLI
        run: |
          databricks configure --token <<EOF
          ${{ secrets.DATABRICKS_HOST }}
          ${{ secrets.DATABRICKS_TOKEN }}
          EOF

      # â”€â”€ Paso 5: Verificar conexiÃ³n con el workspace â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Verify Databricks connection
        run: |
          databricks workspace ls /

      # â”€â”€ Paso 6: Crear estructura de carpetas en workspace â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create workspace folders
        run: |
          databricks workspace mkdirs /Users/joose5573@gmail.com/databricks-smartdavid/proceso         || true
          databricks workspace mkdirs /Users/joose5573@gmail.com/databricks-smartdavid/scrips          || true
          databricks workspace mkdirs /Users/joose5573@gmail.com/databricks-smartdavid/seguridad       || true
          databricks workspace mkdirs /Users/joose5573@gmail.com/databricks-smartdavid/reversion       || true
          databricks workspace mkdirs /Users/joose5573@gmail.com/databricks-smartdavid/dashboard       || true
          databricks workspace mkdirs /Users/joose5573@gmail.com/databricks-smartdavid/certificaciones || true

      # â”€â”€ Paso 7: Deploy carpeta proceso (notebooks ETL) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy proceso - ETL Notebooks
        run: |
          databricks workspace import_dir proceso/ \
            /Users/joose5573@gmail.com/databricks-smartdavid/proceso \
            --overwrite \
            --exclude-hidden-files

      # â”€â”€ Paso 8: Deploy carpeta scrips (preparaciÃ³n ambiente) â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy scrips - SQL Scripts
        run: |
          databricks workspace import_dir scrips/ \
            /Users/joose5573@gmail.com/databricks-smartdavid/scrips \
            --overwrite \
            --exclude-hidden-files

      # â”€â”€ Paso 9: Deploy carpeta seguridad (grants) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy seguridad - GRANTS y permisos
        run: |
          databricks workspace import_dir seguridad/ \
            /Users/joose5573@gmail.com/databricks-smartdavid/seguridad \
            --overwrite \
            --exclude-hidden-files

      # â”€â”€ Paso 10: Deploy carpeta reversion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy reversion - DROP y REVOKE
        run: |
          databricks workspace import_dir reversion/ \
            /Users/joose5573@gmail.com/databricks-smartdavid/reversion \
            --overwrite \
            --exclude-hidden-files

      # â”€â”€ Paso 11: Deploy carpeta dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy dashboard - Evidencias
        run: |
          databricks workspace import_dir dashboard/ \
            /Users/joose5573@gmail.com/databricks-smartdavid/dashboard \
            --overwrite \
            --exclude-hidden-files

      # â”€â”€ Paso 12: Deploy carpeta certificaciones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy certificaciones
        run: |
          databricks workspace import_dir certificaciones/ \
            /Users/joose5573@gmail.com/databricks-smartdavid/certificaciones \
            --overwrite \
            --exclude-hidden-files

      # â”€â”€ Paso 13: Verificar deploy exitoso â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Verify deployed structure
        run: |
          echo "============================================"
          echo "âœ… ESTRUCTURA DESPLEGADA EN DATABRICKS"
          echo "============================================"
          echo ""
          echo "ðŸ“ /proceso:"
          databricks workspace ls /Users/joose5573@gmail.com/databricks-smartdavid/proceso
          echo ""
          echo "ðŸ“ /scrips:"
          databricks workspace ls /Users/joose5573@gmail.com/databricks-smartdavid/scrips
          echo ""
          echo "ðŸ“ /seguridad:"
          databricks workspace ls /Users/joose5573@gmail.com/databricks-smartdavid/seguridad
          echo ""
          echo "ðŸ“ /reversion:"
          databricks workspace ls /Users/joose5573@gmail.com/databricks-smartdavid/reversion
          echo ""
          echo "============================================"
          echo "âœ… Deploy completado exitosamente"
          echo "============================================"
